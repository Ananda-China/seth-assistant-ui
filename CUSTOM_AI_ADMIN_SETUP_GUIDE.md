# 定制化AI管理后台 - 配置指南

**最后更新**: 2025-11-02  
**状态**: ✅ 后台界面已添加，准备部署

---

## 📋 已完成的工作

### 1. 数据库迁移 ✅
- ✅ `custom_ai_configs` 表已创建
- ✅ 所有必需字段已添加
- ✅ 索引和触发器已配置
- ✅ RLS策略已启用

### 2. 后端API ✅
- ✅ `/api/admin/custom-ai-configs` - 管理员API
- ✅ `/api/chat-custom` - 定制化聊天代理
- ✅ `/api/user/custom-ai-config` - 用户配置检查

### 3. 后台管理界面 ✅
- ✅ 侧边栏菜单已添加"定制化AI管理"选项
- ✅ CustomAIManagement组件已创建
- ✅ 支持创建、编辑、删除配置
- ✅ 配置列表显示

---

## 🚀 部署步骤

### 第1步: 配置环境变量

在Vercel中添加以下环境变量：

```
ADMIN_SECRET=your-secure-admin-secret-key
```

**说明**:
- 这个密钥用于验证管理员身份
- 建议使用强密码（至少32个字符）
- 示例: `ADMIN_SECRET=your_secure_random_string_here`

### 第2步: 部署代码

代码已提交到GitHub，Vercel会自动部署。或者手动部署：

```bash
npm run deploy
```

### 第3步: 验证部署

1. 打开后台管理界面
2. 在侧边栏中应该看到"定制化AI管理"选项
3. 点击进入，应该看到"添加配置"按钮

---

## 📝 使用指南

### 添加定制化AI配置

1. **进入定制化AI管理页面**
   - 点击侧边栏的"定制化AI管理"

2. **点击"添加配置"按钮**
   - 打开配置表单

3. **填写配置信息**
   - **客户ID**: 用户的UUID（从users表获取）
   - **Dify应用ID**: 在Dify中创建的应用ID
   - **Dify API密钥**: Dify应用的API密钥
   - **Dify API URL**: Dify API端点（例如: https://api.dify.ai/v1）
   - **知识库ID** (可选): Dify中的知识库ID
   - **系统提示词** (可选): 自定义的系统提示词

4. **点击"创建"按钮**
   - 配置将被保存到数据库

### 编辑配置

1. 在配置列表中找到要编辑的配置
2. 点击"编辑"按钮
3. 修改信息
4. 点击"更新"按钮

**注意**: 编辑时客户ID不能修改（防止数据混乱）

### 删除配置

1. 在配置列表中找到要删除的配置
2. 点击"删除"按钮
3. 确认删除

---

## 🔐 安全性说明

### API密钥保护
- ✅ API密钥存储在Supabase数据库
- ✅ 密钥仅在后端处理
- ✅ 密钥不会返回给前端
- ✅ 密钥不会在网络请求中暴露

### 管理员认证
- ✅ 使用 `x-admin-token` 请求头验证
- ✅ 令牌必须与 `ADMIN_SECRET` 环境变量匹配
- ✅ 未授权的请求将被拒绝

### 数据隔离
- ✅ 每个客户只能有一个配置（UNIQUE约束）
- ✅ 用户只能访问自己的配置（RLS策略）
- ✅ 管理员可以访问所有配置

---

## 🧪 测试配置

### 测试步骤

1. **创建测试配置**
   - 在后台添加一个测试配置
   - 使用测试用户的UUID作为customer_id
   - 使用测试Dify应用的信息

2. **验证配置**
   - 查看配置是否出现在列表中
   - 检查所有字段是否正确保存

3. **测试聊天功能**
   - 使用配置的客户账户登录
   - 发送聊天消息
   - 验证是否使用了定制化AI实例

4. **验证现有用户**
   - 使用非定制化用户账户登录
   - 验证仍然使用共享AI服务

---

## 📊 配置列表说明

### 表格列

| 列名 | 说明 |
|------|------|
| 客户ID | 用户的UUID（显示前8个字符） |
| 应用ID | Dify应用ID |
| API URL | Dify API端点（显示前30个字符） |
| 状态 | 配置是否启用（启用/禁用） |
| 创建时间 | 配置创建的日期 |
| 操作 | 编辑/删除按钮 |

---

## ⚠️ 常见问题

### Q1: 添加配置时提示"未授权"
**A**: 检查是否设置了 `ADMIN_SECRET` 环境变量，并确保在后台登录时使用了正确的管理员令牌。

### Q2: 客户ID在哪里获取？
**A**: 客户ID是用户的UUID，可以从Supabase的users表中获取。

### Q3: 如何获取Dify应用ID和API密钥？
**A**: 
1. 登录Dify平台
2. 创建或选择一个应用
3. 进入应用设置
4. 复制应用ID和API密钥

### Q4: 定制化用户如何使用定制化AI？
**A**: 定制化用户登录后，系统会自动检测其配置，并自动使用定制化AI实例进行聊天。用户无需任何额外操作。

### Q5: 如何禁用某个客户的定制化AI？
**A**: 编辑配置，将"是否启用"改为禁用。或者删除配置，用户将回到共享AI服务。

---

## 📞 支持信息

- **环境变量**: ADMIN_SECRET
- **API端点**: /api/admin/custom-ai-configs
- **后台页面**: /admin (定制化AI管理)
- **数据库表**: custom_ai_configs

---

## ✅ 部署检查清单

- [ ] 环境变量 `ADMIN_SECRET` 已配置
- [ ] 代码已部署到Vercel
- [ ] 后台可以访问"定制化AI管理"页面
- [ ] 可以成功添加配置
- [ ] 配置出现在列表中
- [ ] 定制化用户可以使用定制化AI
- [ ] 非定制化用户仍使用共享AI

---

**准备状态**: 🟢 就绪  
**下一步**: 配置环境变量并部署到Vercel

