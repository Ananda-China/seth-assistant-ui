# 业务数据清理指南

## 📋 概述

本脚本用于安全清理聊天网站的业务数据，为全新测试做准备。

## ⚠️ 重要说明

### 清理的数据（业务数据）
- ✅ 用户注册登录信息 (`users` 表)
- ✅ 聊天对话和消息 (`conversations`, `messages` 表)
- ✅ 激活码 (`activation_codes` 表)
- ✅ 订单和支付信息 (`orders` 表)
- ✅ 用户订阅 (`subscriptions` 表)
- ✅ 用户余额 (`balances` 表)
- ✅ 佣金记录 (`commission_records` 表)
- ✅ 提现申请 (`withdrawal_requests` 表)

### 保留的数据（系统配置）
- ✅ 管理员账号 (`admins` 表)
- ✅ 套餐配置 (`plans` 表) - 次卡、月套餐、年套餐
- ✅ 客服二维码 (`qr_codes` 表)
- ✅ 系统配置和功能

## 🚀 使用方法

### 1. 确保环境配置正确

确保 `.env.local` 文件包含以下配置：

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 2. 运行清理脚本

```bash
node scripts/safe-clear-business-data.js
```

### 3. 脚本执行流程

1. **统计数据** - 显示清理前各表的记录数
2. **备份数据** - 自动备份所有业务数据到 `backups/` 目录
3. **等待确认** - 等待5秒，可按 Ctrl+C 取消
4. **清理数据** - 按照外键依赖关系顺序清理
5. **验证结果** - 显示清理后的统计信息

## 📦 备份文件

备份文件保存在 `backups/` 目录，文件名格式：

```
business-data-backup-2025-10-19T12-30-45.json
```

备份文件包含：
- 时间戳
- 清理前的统计信息
- 所有业务数据的完整内容

## 🔍 清理顺序

脚本按照以下顺序清理数据（遵循外键依赖关系）：

1. 提现申请 (`withdrawal_requests`)
2. 佣金记录 (`commission_records`)
3. 用户余额 (`balances`)
4. 用户订阅 (`subscriptions`)
5. 订单 (`orders`)
6. 激活码 (`activation_codes`)
7. 聊天消息 (`messages`)
8. 对话 (`conversations`)
9. 用户 (`users`)

## ✅ 清理后验证

清理完成后，脚本会自动验证：

1. **业务数据已清空** - 所有业务表记录数为 0
2. **系统配置保留** - 管理员、套餐、二维码等配置完好

## 🧪 清理后测试

清理完成后，您可以：

1. **注册新用户** - 测试用户注册流程
2. **激活码测试** - 在管理后台生成激活码并测试
3. **聊天测试** - 测试新用户免费5次聊天
4. **支付测试** - 测试套餐购买流程

## 🔄 恢复数据

如果需要恢复数据，请：

1. 找到备份文件：`backups/business-data-backup-*.json`
2. 联系技术支持进行数据恢复
3. 或使用 Supabase 控制台手动导入数据

## ⚠️ 注意事项

1. **生产环境慎用** - 此脚本会永久删除数据，请谨慎使用
2. **备份重要** - 清理前会自动备份，请确保备份成功
3. **管理员账号** - 清理后管理员账号仍然可用
4. **套餐配置** - 次卡、月套餐、年套餐配置保留
5. **功能完整** - 清理后所有功能正常使用

## 📊 示例输出

```
🚀 安全业务数据清理工具

⚠️  警告: 此操作将清理所有业务数据！
✅ 保留: 管理员账号、套餐配置、客服二维码

📊 清理前数据统计：

   用户 (users): 15 条记录
   对话 (conversations): 45 条记录
   消息 (messages): 230 条记录
   订单 (orders): 8 条记录
   订阅 (subscriptions): 5 条记录
   激活码 (activation_codes): 20 条记录
   余额 (balances): 3 条记录
   佣金记录 (commission_records): 2 条记录
   提现申请 (withdrawal_requests): 1 条记录

💾 备份数据到本地...

   备份 用户...
      ✅ 已备份 15 条记录
   备份 对话...
      ✅ 已备份 45 条记录
   ...

✅ 备份完成: backups/business-data-backup-2025-10-19T12-30-45.json

⚠️  即将清理以下数据：
   - 用户: 15 条记录
   - 对话: 45 条记录
   - 消息: 230 条记录
   ...

⏳ 等待5秒后开始清理...
   如需取消，请按 Ctrl+C

🗑️  开始清理...

1️⃣ 清理提现申请...
   ✅ 提现申请已清理

2️⃣ 清理佣金记录...
   ✅ 佣金记录已清理

...

9️⃣ 清理用户...
   ✅ 用户已清理

📊 清理后数据统计：

   用户 (users): 0 条记录 (清理了 15 条)
   对话 (conversations): 0 条记录 (清理了 45 条)
   消息 (messages): 0 条记录 (清理了 230 条)
   ...

✅ 验证保留的系统配置：

   管理员账号: 1 个
   套餐配置: 3 个
   客服二维码: 1 个

✅ 业务数据清理完成！
📦 备份文件: backups/business-data-backup-2025-10-19T12-30-45.json

💡 提示: 如需恢复数据，请联系技术支持
```

## 🆘 常见问题

### Q1: 清理后管理员账号还能用吗？
**A:** 可以！管理员账号不会被清理，清理后可以直接登录管理后台。

### Q2: 清理后套餐配置还在吗？
**A:** 在！次卡、月套餐、年套餐的配置都会保留。

### Q3: 清理后能生成激活码吗？
**A:** 可以！清理后可以在管理后台正常生成激活码。

### Q4: 如果清理错了怎么办？
**A:** 脚本会自动备份所有数据到 `backups/` 目录，可以使用备份文件恢复。

### Q5: 清理需要多长时间？
**A:** 通常1-2分钟，取决于数据量大小。

## 📞 技术支持

如有问题，请联系技术支持或查看项目文档。

