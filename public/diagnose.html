<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户数据诊断工具</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #23284A;
      color: #EAEBF0;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #EAEBF0;
      margin-bottom: 30px;
      text-align: center;
    }

    .input-section {
      background: #2D3250;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    input {
      flex: 1;
      padding: 12px;
      border: 1px solid #424769;
      border-radius: 6px;
      background: #23284A;
      color: #EAEBF0;
      font-size: 16px;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      background: #7C3AED;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #6D28D9;
    }

    button:disabled {
      background: #424769;
      cursor: not-allowed;
    }

    .result-section {
      background: #2D3250;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .result-section h2 {
      color: #EAEBF0;
      margin-bottom: 15px;
      border-bottom: 2px solid #424769;
      padding-bottom: 10px;
    }

    .info-box {
      background: #23284A;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border-left: 4px solid #7C3AED;
    }

    .info-box.error {
      border-left-color: #EF4444;
    }

    .info-box.warning {
      border-left-color: #F59E0B;
    }

    .info-box.success {
      border-left-color: #10B981;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #424769;
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #8A94B3;
      font-weight: 500;
    }

    .info-value {
      color: #EAEBF0;
      font-weight: 600;
    }

    .conversation-item {
      background: #23284A;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 3px solid #7C3AED;
    }

    .conversation-item.deleted {
      border-left-color: #EF4444;
      opacity: 0.7;
    }

    .message-item {
      background: #1A1D35;
      padding: 10px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 14px;
    }

    .message-role {
      color: #7C3AED;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .fix-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .fix-buttons button {
      flex: 1;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #8A94B3;
    }

    pre {
      background: #1A1D35;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 14px;
      color: #EAEBF0;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .badge.deleted {
      background: #EF4444;
      color: white;
    }

    .badge.active {
      background: #10B981;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 用户数据诊断工具</h1>

    <div class="input-section">
      <div class="input-group">
        <input 
          type="text" 
          id="phoneInput" 
          placeholder="输入手机号（例如：13828472314）"
          value="13828472314"
        />
        <button onclick="diagnoseUser()">诊断</button>
      </div>
    </div>

    <div id="result"></div>
  </div>

  <script>
    async function diagnoseUser() {
      const phone = document.getElementById('phoneInput').value.trim();
      if (!phone) {
        alert('请输入手机号');
        return;
      }

      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<div class="loading">🔄 正在诊断...</div>';

      try {
        const response = await fetch(`/api/admin/diagnose-user?phone=${phone}`);
        const data = await response.json();

        if (!response.ok) {
          resultDiv.innerHTML = `
            <div class="result-section">
              <div class="info-box error">
                <h3>❌ 诊断失败</h3>
                <p>${data.error || data.message || '未知错误'}</p>
              </div>
            </div>
          `;
          return;
        }

        renderResult(data);
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="result-section">
            <div class="info-box error">
              <h3>❌ 请求失败</h3>
              <p>${error.message}</p>
            </div>
          </div>
        `;
      }
    }

    function renderResult(data) {
      const resultDiv = document.getElementById('result');
      
      let html = '';

      // 用户信息
      if (data.user) {
        html += `
          <div class="result-section">
            <h2>👤 用户信息</h2>
            <div class="info-box success">
              <div class="info-item">
                <span class="info-label">手机号:</span>
                <span class="info-value">${data.user.phone}</span>
              </div>
              <div class="info-item">
                <span class="info-label">昵称:</span>
                <span class="info-value">${data.user.nickname || '未设置'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">订阅类型:</span>
                <span class="info-value">${data.user.subscription_type}</span>
              </div>
              <div class="info-item">
                <span class="info-label">聊天次数:</span>
                <span class="info-value">${data.user.chat_count} / ${data.user.chat_limit}</span>
              </div>
              <div class="info-item">
                <span class="info-label">状态:</span>
                <span class="info-value">${data.user.status}</span>
              </div>
            </div>
          </div>
        `;
      }

      // 问题列表
      if (data.issues && data.issues.length > 0) {
        html += `
          <div class="result-section">
            <h2>⚠️ 发现的问题</h2>
            ${data.issues.map(issue => `
              <div class="info-box error">
                <p>${issue}</p>
              </div>
            `).join('')}
          </div>
        `;
      }

      // 对话统计
      html += `
        <div class="result-section">
          <h2>📊 对话统计</h2>
          <div class="info-box">
            <div class="info-item">
              <span class="info-label">总对话数:</span>
              <span class="info-value">${data.allConversations.length}</span>
            </div>
            <div class="info-item">
              <span class="info-label">未删除对话:</span>
              <span class="info-value">${data.activeConversations.length}</span>
            </div>
            <div class="info-item">
              <span class="info-label">已删除对话:</span>
              <span class="info-value">${data.allConversations.length - data.activeConversations.length}</span>
            </div>
          </div>
        </div>
      `;

      // 对话列表
      if (data.allConversations.length > 0) {
        html += `
          <div class="result-section">
            <h2>💬 对话列表</h2>
            ${data.allConversations.map(conv => {
              const messages = data.messages[conv.id];
              return `
                <div class="conversation-item ${conv.is_deleted ? 'deleted' : ''}">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                      <strong>${conv.title}</strong>
                      ${conv.is_deleted ? '<span class="badge deleted">已删除</span>' : '<span class="badge active">活跃</span>'}
                    </div>
                    <div style="font-size: 12px; color: #8A94B3;">
                      ${new Date(conv.updated_at).toLocaleString('zh-CN')}
                    </div>
                  </div>
                  ${messages ? `
                    <div style="font-size: 14px; color: #8A94B3; margin-bottom: 8px;">
                      消息数: ${messages.messageCount}
                    </div>
                    ${messages.messages.slice(0, 3).map(msg => `
                      <div class="message-item">
                        <div class="message-role">${msg.role === 'user' ? '👤 用户' : '🤖 AI'}</div>
                        <div>${msg.content}</div>
                        <div style="font-size: 12px; color: #8A94B3; margin-top: 5px;">
                          ${new Date(msg.created_at).toLocaleString('zh-CN')}
                          ${msg.is_deleted ? ' <span style="color: #EF4444;">(已删除)</span>' : ''}
                        </div>
                      </div>
                    `).join('')}
                    ${messages.messageCount > 3 ? `<div style="text-align: center; color: #8A94B3; margin-top: 8px;">还有 ${messages.messageCount - 3} 条消息...</div>` : ''}
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      // 修复建议
      if (data.fixSuggestions && data.fixSuggestions.length > 0) {
        html += `
          <div class="result-section">
            <h2>🔧 修复建议</h2>
            ${data.fixSuggestions.map(fix => `
              <div class="info-box warning">
                <h3>${fix.issue}</h3>
                <p><strong>解决方案:</strong> ${fix.solution}</p>
                <pre>${fix.sql}</pre>
              </div>
            `).join('')}
            <div class="fix-buttons">
              <button onclick="fixUser('${data.phone}', 'restore_all')">恢复所有对话</button>
              <button onclick="fixUser('${data.phone}', 'restore_latest')">只恢复最新对话</button>
            </div>
          </div>
        `;
      }

      resultDiv.innerHTML = html;
    }

    async function fixUser(phone, action) {
      if (!confirm(`确定要执行操作: ${action === 'restore_all' ? '恢复所有对话' : '只恢复最新对话'}？`)) {
        return;
      }

      try {
        const response = await fetch('/api/admin/fix-user-conversations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ phone, action })
        });

        const data = await response.json();

        if (data.success) {
          alert(`✅ ${data.message}`);
          // 重新诊断
          diagnoseUser();
        } else {
          alert(`❌ ${data.message}`);
        }
      } catch (error) {
        alert(`❌ 修复失败: ${error.message}`);
      }
    }

    // 页面加载时自动诊断
    window.onload = () => {
      const phone = document.getElementById('phoneInput').value;
      if (phone) {
        diagnoseUser();
      }
    };
  </script>
</body>
</html>

